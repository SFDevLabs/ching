extends ../layouts/default

block extrahead
  link(rel='stylesheet', href='/css/jquery.handsontable.bootstrap.css')
  link(rel='stylesheet', href='/css/jquery.handsontable.full.css')
  link(rel='stylesheet', href='/css/jquery-ui.min.css')
  link(rel='stylesheet', href='/css/jquery-ui.ching.theme.css')

block main
  .controls
    .container
      .row
        .col-md-8
          - if (req.user && req.article && req.article.user.id===req.user.id)
            button.btn.btn-default.btn-edit Edit
            | &nbsp;

            form(action="/articles/"+article.id, method="post")
              input(type='hidden', name='_csrf', value="#{csrf_token}")

              input(type="hidden", name="_method", value="DELETE")
              
              button.btn.btn-danger(type="submit") Delete

            form(action="/articles/"+article.id+'/send', method="post")
              input(type='hidden', name='_csrf', value="#{csrf_token}")
              input(type="hidden", name="_method", value="POST")
              button.btn.btn-info(type="submit") Send

            a.btn(href="/articles/" + article._id + "/pdf") Download PDF 
            //- button.btn.btn-danger.btn-link.error(type="submit") Download PDF 




block content
  .container.invoice-form.view-state
    .row
      div.left.col-md-8
        - if (!article.isNew && article.image && article.image.files && article.image.files.length)
          img(class="col-md-3", src=article.image.cdnUri + "/mini_" + article.image.files[0])
          - var hasImage = "col-md-9"
        - else
          - var hasImage = ""
        -if (article.status.text == "sent")
          h2(class="#{article.status.text} #{hasImage}") #{article.status.text} #{article.status.invoicedOn}
        -else if (article.status.text == "paid")
          h2(class="#{article.status.text} #{hasImage}") #{article.status.text} #{article.status.paidOn}
        -else if (article.status.text == "overdue")
          -var today = new Date()
          -var pastDue = new Date((today.getTime() - article.dueOn.getTime())).toDateString()
          h2(class="#{article.status.text} #{hasImage}") #{article.status.text} #{pastDue}
        -else
          h2(class="#{article.status.text} #{hasImage}") #{article.status.text}

        -if (article.title)
          h1= article.title
        -else
          h1 Invoice 
        -if (article.status.text != "draft" && req.user && req.article.user.id===req.user.id)
          h3 Views:&nbsp;
            - each view in article.views
              - if (view.user!=null)
                .view
                  span.firstname=view.user.firstname
                  | &nbsp;
                  span.lastname=view.user.lastname
                  | &nbsp; with &nbsp;
                  span.organization=view.user.organization
                  | &nbsp;(
                  span.email.muted=view.user.email
                  | )&nbsp; at &nbsp;
                  span.time.muted= formatDatetime(view.viewedAt, "%b %d, %Y at %I:%M %p")

      .col-md-4.float-right.right
        h4 Net #{article.net}
        h4
          span Created 
          span= formatDatetime(article.createdAt, "%b %d, %Y at %I:%M %p")

    .row
      .col-md-8
        p=article.body

        .meta.clear.show-view
          form(class="block edit-content", method="post", action=action, enctype="multipart/form-data", role="form")

            input(type="hidden", name="_csrf", value="#{csrf_token}")

            - if (!article.isNew)
              input(type="hidden", name="_method", value="PUT")

            .form-group
              label.control-label(for='title') Title
              input.form-control#title(type='text', name="title", value=article.title, placeholder='Enter the title')

            .form-group
              label.control-label(for='file') Image
              input.form-control#file(type='file', name="image[]")

            .form-group
              label.control-label(for='desc') Body
              textarea.form-control#desc(rows="5", name="body", placeholder='Enter the article description')=article.body

            .form-group
              label.control-label(for='tags') Tags
              input.form-control#tags(type='text', name="tags", value=article.tags, placeholder='Enter the tags')

            .form-group
              label.control-label(for='tags') Net
              input.form-control#tags(type='number', name="net", value=article.net, placeholder='net')

            .form-group
              .col-sm-10
                button.left-float.btn.btn-primary(type='submit') Save
                | &nbsp;
                a.right-float.btn(href='/articles', title="cancel") Cancel

            .col-md-4
              - if (!article.isNew && article.image && article.image.files && article.image.files.length)
                img(src=article.image.cdnUri + "/mini_" + article.image.files[0])
          div.view-content
            - if (article.user)
              - var name = article.user.name ? article.user.name : article.user.username
              .clear.to-block.clearfix
                p.col-sm-2 To: 
                -if(article.viewers.length > 0)
                  - each viewer, i in article.viewers
                    div.col-sm-2.to
                      p #{viewer.user.firstname} #{viewer.user.lastname}
                      p=viewer.user.email
                      p=viewer.user.organization
                    hr.clear
                    form.form-inline(role="form", method="post", action="/articles/" + article._id + "/viewer/" + viewer._id, onsubmit="return confirm('Are you sure?')")
                      input(type='hidden', name='_csrf', value="#{csrf_token}")
                      input(type="hidden", name="_method", value="DELETE")
                      div.close-button
                        span.typcn.typcn-delete
              .clear
                p.col-sm-2 From:&nbsp;
                  -if(article.user.organization)
                    p.muted='organization:'
                    p=article.user.organization
                  p.col-sm-2=article.user.email
                  span=article.user.lastname
                  span=article.user.firstname
                hr.clear


                - if (article.tags)
                  p Tags &nbsp;
                    - each tag in article.tags.split(',')
                      i.muted.fa.fa-tag &nbsp;
                      a.tag(href="/tags/"+tag)= tag
                      | &nbsp;&nbsp;
      .col-md-4
        button.right.btn.subtle.add-recipient-trigger.closed
          span.typcn.typcn-user-add
            |  Add Recipient
        .row.clear
          .right-float.add-recipient-form
            div.add-recipient-position
              span.close-button
                span.typcn.typcn-delete
              form.block(method="post", action='/articles/' + article.id + '/viewer', enctype="multipart/form-data", role="form")
                input(type="hidden", name="_csrf", value="#{csrf_token}")
                input(type="hidden", name="_method", value="POST")
                .form-group
                  label.control-label(for='title') Email
                  input.form-control#title(type='text', name="email")
                .form-group
                  label.control-label(for='title') First Name
                  input.form-control#title(type='text', name="firstname")
                .form-group
                  label.control-label(for='title') Last Name
                  input.form-control#title(type='text', name="lastname")
                .form-group
                  label.control-label(for='title') Organization <em><strong>(Optional)</strong></em>
                  input.form-control#title(type='text', name="organization")
                .form-group
                  button.btn.subtle(type='submit')
                    span.typcn.typcn-user-add
                      |  Save
      .clear
        .col-md-12
          hr
        
        
  .container
    .row
      button#pop_car.btn.btn-default
        | Pop
    .row
      #grid
      table.remove-sidebar
        tbody
    .row.clear
      hr
      div#total
        span
          |Total:&nbsp;
        span.amount
    hr
    .row
      .col-md-12
        .col-md-6
          h3 Enter items one at a time
          button#add_car_time.btn.btn-default
            span.typcn.typcn-watch
            |  Add Time
          button#add_car_item.btn.btn-default
            span.typcn.typcn-plus
            |  Add Item
        .col-md-6
          h3 Import from file
          p
            input(id="fileupload", type="file", name="files[]", multiple)
          #dropzone
            span.typcn.typcn-folder-open
          div(id="files", class="files")
          br
          textarea#csv-ajax
      .col-md-12
        .col-md-6
          button.btn.btn-danger#destroyPreview Cancel
          #preview


          



  .container
    .row
      .col-md-12
        hr
        .col-md-8
          h3 Comments
          - each comment in article.comments
            include ../comments/comment
          include ../comments/form

block subfoot
  script(type="text/javascript", src='/js/vendor/jquery-ui.js')
  script(type="text/javascript", src="/js/vendor/underscore-min.js")
  script(type="text/javascript", src="/js/vendor/backbone-min.js")
  script(type="text/javascript", src="/js/vendor/jquery.handsontable.full.js")
  script(type="text/javascript", src="/js/vendor/jquery.ui.widget.js")
  script(type="text/javascript", src="/js/vendor/jquery.iframe-transport.js")
  script(type="text/javascript", src="/js/vendor/jquery.fileupload.js")
  script(type="text/javascript", src="/js/todos.js")
  script.
    $( document ).ready(function() {
      $(".add-recipient-form").hide();
      $(".invoice-form").on("click", ".add-recipient-trigger.closed", function() {
        $(".add-recipient-form").fadeIn();
        $(".add-recipient-trigger").removeClass("closed").addClass("opened");
      });
      $(".invoice-form").on("click", ".add-recipient-trigger.opened, .add-recipient-form .close-button", function() {
        $(".add-recipient-form").fadeOut();
        $(".add-recipient-trigger").removeClass("opened").addClass("closed");
      });

      $(".edit-content").hide();
      $("body").addClass("view-state");
      $("body.view-state").on("click", ".btn-edit", function() {
        $(".edit-content").slideDown();
        $("body").removeClass("view-state").addClass("edit-state");          
      });
      $(".invoice-form.edit-state").on("click", ".add-recipient-trigger.opened", function() {
        $(".add-recipient-form").fadeOut();
        $(".add-recipient-trigger").removeClass("opened").addClass("closed");
      });

    });
